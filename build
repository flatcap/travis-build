#!/bin/bash

set -o errexit	# set -e
set -o nounset	# set -u

eval CONFIG_DIR="~/config"

# Disable one warning, but fail on any others
CFLAGS="-Wno-unused-result -Werror"

function get_config_location()
{
	local TEST="/$1"

	while [ -n "$TEST" ]; do
		if [ -f "$CONFIG_DIR${TEST}.txt" ]; then
			echo "$CONFIG_DIR${TEST}.txt"
			return
		fi
		TEST="${TEST%/*}"
	done

	echo "$CONFIG_DIR/default.txt"
}

function _run_build()
{
	if [[ $# -ne 4 ]]; then
		echo "Illegal arguments passed."
		return
	fi
	BRANCH="$1"
	LEN="$2"
	FILE="$3"
	CONFIG_DIR="$4"

	echo "-------------------------------------------------------------------------------"
	echo "BRANCH:         https://github.com/neomutt/neomutt/tree/$BRANCH"
	echo "COMMIT:         https://github.com/neomutt/neomutt/commit/$(git rev-parse HEAD)"
	echo "CONFIG FILE:    https://github.com/neomutt/travis-build/blob/master/${FILE#$CONFIG_DIR/}"
	echo "CONFIGURATIONS: $LEN"
	echo "-------------------------------------------------------------------------------"
	BUILD_COUNT=0
	while read CONFIG; do
		: $((BUILD_COUNT++))
		echo "BUILD: $BUILD_COUNT/$LEN"
		if [ -n "$CONFIG" ]; then
			echo $CONFIG | fmt -w 75 | sed 's/^/    /'
		else
			echo "    <no options>"
		fi
		echo
		git clean -xdfq
		autoreconf --install --force > /dev/null
		if [[ $BRANCH == "mutt/"* ]]; then
			./configure --quiet --disable-doc --enable-silent-rules $CONFIG || exit 1
		else
			./configure --quiet --disable-doc --disable-po --enable-silent-rules $CONFIG CFLAGS="$CFLAGS" || exit 1
		fi
		make -s -j2 || exit 1
		echo
		[ -f mutt    ] && ./mutt -v
		[ -f neomutt ] && ./neomutt -v
		echo "-------------------------------------------------------------------------------"
	done < "$FILE"
}


if [ -n "${TRAVIS_BRANCH:-}" ]; then
	BRANCH="$TRAVIS_BRANCH"
else
	BRANCH=$(git rev-parse --abbrev-ref HEAD)
fi

if [[ "${TRAVIS_PULL_REQUEST:-}" =~ ^[0-9]+$ ]]; then
	FILE="$CONFIG_DIR/pull-request.txt"
else
	FILE=$(get_config_location $BRANCH)
fi

LEN=$(wc -l "$FILE" | cut -d' ' -f1)

_run_build "$BRANCH" "$LEN" "$FILE" "$CONFIG_DIR"

if [[ $BRANCH = "master" && ! "${TRAVIS_PULL_REQUEST:-}" =~ ^[0-9]+$ ]]; then
	# Do a full build and test it
	git clean -xdfq
	autoreconf --install --force > /dev/null
	./configure --quiet --prefix=$HOME/install $(tail -n 1 $(get_config_location master)) CFLAGS="$CFLAGS"
	echo "-------------------------------------------------------------------------------"
	echo "MAKE"
	make -j2
	echo "-------------------------------------------------------------------------------"
	echo "VALIDATE"
	make -C doc validate
	echo "-------------------------------------------------------------------------------"
	echo "INSTALL"
	make install
	echo "-------------------------------------------------------------------------------"
	echo "DIST"
	make -s dist
	echo "-------------------------------------------------------------------------------"
	echo "DISTCHECK"
	make -s distcheck
	echo "-------------------------------------------------------------------------------"
fi

if [[ $BRANCH = "feature/unit-test" ]]; then
	echo "-------------------------------------------------------------------------------"
	echo "TEST"
	./mutt -T
	echo "-------------------------------------------------------------------------------"
fi

echo Success
exit 0

